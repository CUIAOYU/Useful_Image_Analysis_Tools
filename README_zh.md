# Useful Image Analysis Tools

这是一个使用 PyQt6 构建的图形用户界面 (GUI) 工具，目的是为了简化和加速科研或实验中常见的图像分析与处理任务，特别是针对需要批量处理大量图像（如显微照片、组织切片扫描图等）的场景。它可以帮你自动提取定量信息、比较图像特征或改善图像视觉效果。

## 主要功能

* **对比度增强**:
    * **作用**: 增大图像亮暗区域的差异，让图像细节更清楚。
    * **批量**: 可以一次性处理文件夹里所有的图片。
    * **调节**: 你可以自己设置增强的程度（大于1增强，小于1减弱）。

* **聚合分析**:
    * **“聚合度”是啥**: 我定义了一个叫“聚合度”的指标 (0-100)，用来衡量像素有多“暗”。简单说，**颜色越深，聚合度越高**。
        * **公式**: `聚合度 = 100 - (灰度值 / 255.0) * 100`
        * **例子**: 纯黑像素聚合度是 100，纯白是 0。
    * **快速评估**: 计算整张图或整个文件夹图片的**平均聚合度**，快速了解样本整体的“暗度”或“聚合水平”。

* **热力图生成**:
    * **作用**: 把每个像素的“聚合度”用不同颜色表示出来，生成一张彩色的图，直观展示聚合度在哪儿高、在哪儿低。
    * **怎么做**:
        1.  计算图片里每个像素的聚合度 (0-100)。
        2.  你设定一个感兴趣的聚合度**范围**（最低值 `Min Aggregate Threshold` 和最高值 `Max Aggregate Threshold`）。
        3.  **颜色规则**:
            * 聚合度**低于**最低值的像素：显示为**黑色** (背景)。
            * 聚合度**高于**最高值的像素：显示为**亮红色** (饱和)。
            * 聚合度在**范围内**的像素：颜色从**绿色** (接近最低值，聚合度低/较亮) 平滑过渡到 **黄色/橙色**，再到 **红色** (接近最高值，聚合度高/较暗)。
    * **目的**: 通过调整阈值，把注意力集中在感兴趣的聚合度区间，过滤掉背景或过曝区域，突出目标区域的分布和强度变化。

* **SAM 处理**:
    * **作用**: 把 Segment Anything Model (AI 自动分割) 和聚合度分析结合起来。它先自动找出图里的各个独立区域，然后用你设定的条件（分两步）筛选出你关心的目标，最后计算这些目标的指标（面积、强度、比率）并在图上标出来。
    * **模型**: 你需要自己提供预训练好的 SAM 模型文件 (`.pth`)。
    * **自动分割**: SAM 会自动把图像分割成很多独立的区域（生成掩码 masks）。
    * **两步筛选**:
        1.  **第一步：按区域整体属性筛选 (A/I/R Threshold)**:
            * 先算每个 SAM 找到的区域的**初始**面积、强度、比率。
            * 如果你勾选了 "Area" 或 "Intensity"，程序会检查这些初始值是否达到你设置的最小阈值 (`A/I/R Threshold`)。
            * 任何一个初始值**不达标**的区域，**直接淘汰**，不进入下一步。
        2.  **第二步：按像素聚合度筛选 (Min/Max Aggregate Threshold)**:
            * 对于**通过第一步**的区域，再检查它里面的**每一个像素**。
            * 只有聚合度落在你设定的 \[最低值, 最高值\] **区间内**的像素，才算这个区域的“有效像素”。
            * 如果一个区域通过了第一步，但在第二步检查后**一个“有效像素”都没有**，那这个区域**最终也不会被标记和计算**。
    * **最终计算和标注**:
        * 对于**两步都通过**的区域，程序**只用**第二步找到的“有效像素”来**重新计算**最终的：
            * **面积 (Area)**: 有效像素的数量。
            * **强度 (Intensity)**: 所有有效像素的聚合度加起来。
            * **比率 (Ratio)**: 强度 / 面积。
        * 程序会在输出图片上画出这个区域的**原始轮廓**，并用彩色文字标出**最终算出来**的 A/I/R 值。文字颜色与轮廓颜色相同，你可以用眼睛去挑选感兴趣的区域，并读出该区域的数值。
    * **详细参数调整 (SAM Auto Mask Generator Parameters)**: SAM 提供一些高级选项，让你可以微调它的工作方式。了解它们有助于解决特定问题：
        * **`points_per_side`** (每边点数, 默认 32): 想象在图上撒网格找物体，这个值是网格每边的点数。**值越高，网格越密**，更容易找到小东西，但也**更慢、更吃内存/显存**。反之则更快，但可能漏掉小的。
        * **`points_per_batch`** (每批点数, 默认 64): 决定了显卡 (GPU) 一次处理多少个网格点。**主要影响显存**。如果遇到 **"Out of Memory" 错误，就降低这个值** (比如 32 或 16)。如果显存很大，可以稍微提高试试能否加速。
        * **`pred_iou_thresh`** (预测 IoU 阈值, 默认 0.88): SAM 对自己找到的区域打的分数 (0-1)，表示它有多自信这个区域找对了。**值越高 (接近1)，要求越严**，结果噪点少，但可能把一些模糊的或者不太确定的目标漏掉。**值越低，要求越松**，可能找回一些目标，但也可能引入更多错误分割。
        * **`stability_score_thresh`** (稳定性阈值, 默认 0.95): 衡量找到的区域边界稳不稳固 (0-1)。稍微变动一下判断标准，形状会不会大变？**值越高，要求边界越稳定清晰**，结果更可靠，但可能丢掉边界模糊的目标。**值越低，能容忍更模糊的边界**，可能找回这类目标，但也可能得到形状奇怪的结果。
        * **`stability_score_offset`** (稳定性偏移, 默认 1.0): 计算稳定性分数时用的一个内部参数。
        * **`box_nms_thresh`** (包围盒 NMS 阈值, 默认 0.7): 防止同一个物体被画上好几个框。如果两个框重叠度高于这个值，就可能只保留一个。**值越低，去重越狠**，可能把靠太近 不同物体当成一个；**值越高，越容忍重叠**，可能同一个物体出好几个框。
        * **`crop_n_layers`** (裁剪层数, 默认 0): 处理超大图片的“切块”开关。**0 表示不切**，对整图处理。**设为 1 或更大**，会把大图切成很多重叠的小块分别处理再拼起来。优点是**能处理内存/显存装不下的大图**，缺点是**速度会慢很多很多**，而且拼接处可能不太自然。**只在处理超大图片遇到内存问题时，才考虑设为 1**。
        * **`crop_nms_thresh`** (裁剪 NMS 阈值, 默认 0.7): 切块模式下，合并小块结果时用的去重叠阈值。
        * **`crop_overlap_ratio`** (裁剪重叠率, 默认 \~0.341): 切块模式下，小块之间重叠部分的比例。
        * **`crop_n_points_downscale_factor`** (裁剪点数缩减因子, 默认 1): 切块模式下，每个小块里撒的点是否要稀疏一些。1 表示不稀疏。**值越大，小块处理越快，但精度可能下降。一般保持为 1**。
        * **`min_mask_region_area`** (最小掩码区域面积, 默认 0): 这是个**后期处理**步骤。设一个**大于 0** 的值（比如 50），程序会自动删掉所有面积小于这个像素数的、独立的、细小的分割结果。**非常适合用来自动清理背景上的小噪点**。设为 0 则保留所有结果。
        * **`output_mode`** (输出模式, 默认 `binary_mask`): 控制 SAM 输出掩码的内部数据格式。

* **批量处理与易用性**:
    * **文件夹处理**: 主要功能都支持一次处理整个文件夹的图片。
    * **图形界面**: 我用 PyQt6 做了个直观的界面，选文件、设参数、看日志、打开结果文件夹都方便。
    * **日志**: 界面右边会显示详细的操作日志和处理信息。
    * **结果输出**: 处理完后，会在你选的输入文件夹旁边自动创建一个新文件夹放结果，文件夹名字会包含参数信息，方便管理。

## 系统要求

* **操作系统**: 推荐 Windows 10 或 11。
* **Anaconda**: 需要预先安装 Anaconda Navigator 或 Miniconda。我们将使用 Conda 来创建和管理运行环境。
* **Python 版本**: 推荐使用 **Python 3.11**。
* **硬件**:
    * 如果希望使用 SAM 处理功能并获得较快速度 (GPU 加速)，建议配备 **NVIDIA 显卡**，至少是 GeForce RTX 3060 或同等性能水平。
    * 如果没有 NVIDIA 显卡，SAM 功能仍然可以在 CPU 上运行，但速度会**慢很多**。其他非 SAM 功能对硬件要求不高。
* **需要安装的 Python 库**:
    * `PyQt6` (用于图形界面)
    * `opencv-python` (用于图像处理)
    * `numpy` (用于数值计算)
    * `Pillow` (用于图像文件读写)
    * `torch` (PyTorch 核心库)
    * `torchvision` (PyTorch 视觉库)
    * `segment-anything` (Meta AI 的 SAM 库)
    * `tifffile` (**推荐安装**: 用于支持读取 `.tif` 或 `.tiff` 格式的图像)
    * `pycocotools` (**可选**: 如果你不需要处理 COCO 数据集格式或 RLE 格式的掩码，可以不安装。Windows 下安装可能需要额外配置编译环境。)

## 安装指南 (使用 Anaconda Navigator 和 Pip)

**第 1 步：安装 Anaconda**

* 如果你电脑上还没有安装 Anaconda，请前往 [Anaconda Distribution 官网](https://www.anaconda.com/products/distribution) 下载适合你 Windows 系统的安装包。
* 下载后运行安装程序，按照提示完成安装。对于大多数选项，保持默认设置即可。

**第 2 步：创建新的工作环境 (使用 Anaconda Navigator)**

环境就像一个独立的“房间”，我们在这个“房间”里安装这个工具需要的所有软件库，这样可以避免和你电脑上其他 Python 项目的库发生冲突。

1.  **打开 Anaconda Navigator**: 在 Windows 开始菜单中找到并启动 "Anaconda Navigator"。它第一次启动可能需要一些时间。
2.  **进入环境管理界面**: 在 Navigator 窗口的左侧菜单栏中，点击 **"Environments"** 选项卡。
3.  **创建新环境**:
    * 在环境列表（初始可能只有 "base (root)"）的下方，找到并点击 **"Create"** (带有加号图标) 按钮。
    * 会弹出一个名为 "Create new environment" 的小窗口。
    * 在 **"Name"** 输入框中，为你的新环境起一个名字，例如 `image_tool` 。
    * 在下方的 "Packages" 部分，确保 **Python** 被选中。点击右侧的版本号下拉菜单，选择 **3.11**。确认名称和 Python 版本无误后，点击窗口右下角的 **"Create"** 按钮。
    * Anaconda 会开始创建环境并安装指定版本的 Python 及一些基础包。请耐心等待，这可能需要几分钟。创建成功后，你会在左侧环境列表中看到你新创建的 `image_tool` 环境。

**第 3 步：安装工具需要的库 (使用 Pip 在环境中安装)**

现在我们需要进入刚刚创建的 `image_tool` 环境，并安装所有必需的 Python 库。我们将使用 `pip` 这个 Python 包管理工具来完成。

1.  **打开环境专属的命令行终端 (Terminal)**:
    * 在 Anaconda Navigator 的 "Environments" 界面，从左侧列表中**点击选中**你刚刚创建的 `image_tool` 环境 (确保它处于高亮状态)。
    * 在中间区域顶部，环境名称 `image_tool` 的右侧，你会看到一个**绿色的播放按钮 (▶️)** 或者一个**向下的小箭头 (🔽)**。点击这个按钮/箭头。
    * 在弹出的菜单中，选择 **"Open Terminal"**。
    * 系统会打开一个**黑色背景的命令行窗口** (CMD 或 PowerShell)。你会注意到窗口的提示符最前面带有 `(image_tool)` 字样，这表示你当前的操作都是在这个独立的环境中进行的。**接下来的所有安装命令都必须在这个窗口中执行**。

2.  **安装 PyTorch (核心库，按官网建议)**:
    * **非常重要**: PyTorch 的安装与你的硬件（特别是显卡）和所需的 CUDA 版本紧密相关。**强烈建议**按照 PyTorch 官网的最新指示进行安装。
    * **打开你的网页浏览器**，访问 PyTorch 官方网站：<https://pytorch.org/>
    * 在官网首页找到 "Get Started" 或类似的安装指引区域。
    * 根据你的情况进行选择：
        * **PyTorch Build**: 通常选择 **Stable** (稳定版)。
        * **Your OS**: 选择 **Windows**。
        * **Package**: **选择 Pip** (根据我之前的经验和官网提示，通常推荐使用 Pip)。
        * **Language**: 选择 **Python**。
        * **Compute Platform**:
            * 如果你的电脑装有 **NVIDIA 显卡** 并且希望使用 GPU 加速 (推荐)，请选择一个 **CUDA** 版本 (如 CUDA 11.8 或 12.1)。
            * 如果你的电脑**没有 NVIDIA 显卡**，或者你不确定，或者你只想使用 CPU 进行计算，请选择 **CPU**。
    * 当你完成以上选择后，页面下方 **"Run this Command:"** 部分会**自动生成**一条安装命令。这条命令通常是以 `pip install torch torchvision torchaudio ...` 开头的。
    * **仔细地、完整地复制这条生成的 `pip install ...` 命令**。
    * **回到你刚才打开的那个带有 `(image_tool)` 前缀的黑色命令行窗口**。
    * **将复制的命令粘贴到窗口中** (通常可以通过在窗口内单击鼠标右键来粘贴)。
    * 按下键盘上的 **回车键 (Enter)** 执行命令。
    * `pip` 会开始下载并安装 PyTorch 及其相关的库。这可能需要较长时间，取决于你的网络速度和下载文件的大小。请耐心等待，直到命令执行完毕并且没有显示错误信息。

3.  **安装其他必需的库**:
    * 在**同一个黑色命令行窗口**中 (确保上一步的 PyTorch 安装成功完成后)，**复制并粘贴**以下命令：
        ```bash
        pip install PyQt6 opencv-python numpy Pillow segment-anything tifffile pycocotools
        ```
    * 按下 **回车键 (Enter)**。
    * `pip` 会开始下载并安装列表中的其他库：PyQt6 (图形界面), opencv-python (图像处理), numpy (科学计算), Pillow (基础图像库), segment-anything (SAM 模型库), tifffile (TIFF 文件支持), pycocotools (COCO 工具)。
    * 请耐心等待所有库下载和安装完成。
    * *(安装提示与常见问题)*:
        * `pycocotools`: 在 Windows 上安装 `pycocotools` 有时会因为缺少 C++ 编译环境而失败。如果你遇到关于 `cl.exe` 或 `Microsoft C++ Build Tools` 的错误，可以尝试先安装 Microsoft C++ Build Tools (可以从 Visual Studio Installer 中获取)。如果你确认用不到 COCO 数据集或 RLE 格式掩码，也可以选择不安装它，只需在上面的命令中去掉 `pycocotools` 即可：`pip install PyQt6 opencv-python numpy Pillow segment-anything tifffile`。程序在缺少它时会给出警告，但核心功能仍可运行。
        * `tifffile`: 如果不安装，将无法读取 `.tif` 或 `.tiff` 格式的图像。
        * 网络问题: 如果下载速度很慢或失败，可能是网络原因。

4.  **关闭命令行窗口**: 当所有库都成功安装后 (命令行不再滚动，并回到 `(image_tool) C:\Users\YourUsername>` 这样的提示符状态)，你可以输入 `exit` 命令并按回车，或者直接点击窗口右上角的 "X" 按钮关闭这个黑色窗口。

## SAM 模型设置 - 重要!

SAM 处理功能需要预训练的模型文件 (`.pth`)。**这些文件很大，代码仓库里不带，得你自己下载。**

1.  **下载模型**:
    * 去 Meta AI Research 的官方 SAM 仓库或者你信得过的其他地方下载模型文件。
    * 常见的模型有 `vit_h` (最大最准但也最慢)、`vit_l` (中等)、`vit_b` (最小最快但可能没那么准)。根据你的需求和电脑配置选一个。
    * **官方链接**: [SAM Model Checkpoints](https://github.com/facebookresearch/segment-anything#model-checkpoints)

2.  **放好模型**:
    * 下载后，把 `.pth` 文件存到你电脑上一个好找的地方。
    * 运行工具时，在 "SAM Processing" 标签页，点 "Select SAM Model File (.pth)" 按钮，告诉程序你把模型文件放哪儿了。

## 如何使用

1.  **准备**: 确保依赖库都装好了，SAM 模型也下载好了。
2.  **激活环境**: 如果用了虚拟环境，先激活。 (我们通过 Anaconda Navigator 打开的 Terminal 已经自动激活了 `image_tool` 环境)
3.  **运行**: 在项目文件夹根目录，打开命令行 (参照安装步骤第 3 步第 1 点打开 `image_tool` 环境的 Terminal)，运行主脚本：
    ```bash
    python 你的主脚本文件名.py
    # 比如: python main_gui.py (具体看你的文件名是啥)
    ```
4.  **界面**: 程序打开后，左边是控制区（选功能、选文件、调参数），右边是日志区（看运行信息和报错）。
5.  **选功能**: 点顶部的标签切换功能 (比如 "Contrast Enhancement", "SAM Processing")。
6.  **设置和运行**:
    * 点 "Select Input Folder" 选要处理的图片文件夹。
    * (用 SAM 的话) 点 "Select SAM Model File (.pth)" 选模型文件。
    * 仔细调整界面上的各种参数。
    * 点蓝色的处理按钮（比如 "Process All Images"）开始跑。通常要先选好文件夹和模型，按钮才能点。
7.  **看结果**:
    * 处理时留意右边日志区的输出。
    * 处理完日志区会有提示。
    * 点 "Open Output Folder" 按钮可以直接打开结果文件夹。结果文件夹会自动建在输入文件夹旁边，名字里会带参数信息。

## 如何贡献

非常欢迎各种形式的贡献！

* **提 Bug 或建议**: 发现问题或者有改进想法？请到 GitHub 的 [Issues](https://github.com/CUIAOYU/Useful-Image-Analysis-Tool-Integration/issues) 页面提出来。描述越详细越好，比如怎么复现、截图、你的系统和软件版本等等。
* **贡献代码**: 想直接改代码？欢迎！请走标准的 GitHub Fork & Pull Request 流程。最好是先开个 Issue 讨论一下你想做的改动。

## 报告问题

遇到 Bug 或有功能需求，请直接在仓库的 [Issues](https://github.com/CUIAOYU/Useful-Image-Analysis-Tool-Integration/issues) 页面开新的 Issue。

## 许可证

本项目使用 **MIT 许可证**。具体看 `LICENSE` 文件。

